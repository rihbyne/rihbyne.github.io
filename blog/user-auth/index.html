<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <title>    Securing User Accounts
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href='https://fonts.googleapis.com/css?family=Gentium+Book+Basic|Merriweather:400,300' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://rihbyne.github.io/theme/css/cid.css">
        <link href="https://rihbyne.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="swlogs Atom Feed" />
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

            <div class="container">

<style rel="text/css">
 body p {
    text-align: justify
 }

 .site-logo {
    float: left;
  }
.container .blog-header h1 , .container .blog-header p {
}
.container .blog-header h1 {

    display: inline-block;
}
.site-logo img {
    width: 100%;
    max-width: 110px;
    height: auto;
margin-right:25px;
}

 .blog-header nav a {
    text-decoration:none;
     color: blue;
 }

 .blog-footer .nav a {
     text-decoration: none;
     color: blue;
 }

 .blog-footer .nav .dots {
     font-weight: bold;
 }
</style>
<header class="blog-header">
  <div class="header-container" style="height: auto">
    <div class="site-logo" >
       <img  src="https://rihbyne.github.io/images/android-chrome-512x512.png">
    </div>
    <div>
      <h1>
       <a href="https://rihbyne.github.io">swlogs</a>
      </h1>
      <p> recording happenings around </p>
    </div>
  </div>
        <nav>
           <a href="https://rihbyne.github.io/blog">INDEX</a>
           <span class="header-dots">.</span>
           <a href="https://rihbyne.github.io/archives">ARCHIVES</a>
           <span class="header-dots">.</span>
           <a href="https://rihbyne.github.io/categories">CATEGORIES</a>
           <span class="header-dots">.</span>
           <a href="https://rihbyne.github.io/tags">TAGS</a>
       </nav>
</header>

    <div class="post">
        <header>
            <h1>Securing User Accounts</h1>
            <p class="date">
              Posted on Feb 03 2016 13:45 in
              <a href="https://rihbyne.github.io/category/security">
                security
              </a>

              &#8226; 2 min read
            </p>
        </header>

        <article>
          <div>
            <p>This post details the popular <strong>Salt &amp; Hashing</strong> technique used to safely store secret/confidential
information into a persistent db.</p>
<p>Some notes about the above practice:</p>
<ul>
<li>
<p>Avoids the possibility of duplicate hash occurrence if a attribute of 2 distinct entities result in same
 value. For example, it is possible to receive similar passwords from multiple users while performing Basic Auth.
 In such a scenario, Salt transforms the input into completely random output which is finally followed by
 Hashing.</p>
</li>
<li>
<p>Good rule of thumb is to avoid storing plain text or raw password directly entered by the user. This technique
 stores the hash of the password along with its corresponding salt value generated.</p>
</li>
<li>
<p>In case the database gets breached, bad guys are left with only hash values of the passwords. They will try to
 detect hash collisions by guessing possible characters for a given hash. If they are patient enough,
 they may succeed and get hold of negligible number of accounts but chances are very rare.</p>
</li>
</ul>
<p>During the following user interactions we make use of the technique. The below code snippets contains explainations in the form of comments.</p>
<ul>
<li>Register</li>
<li>Login</li>
<li>Forgot Password</li>
<li>Reset Password</li>
</ul>
<h2 id="1-register">1. Register</h2>
<hr>
<div class="highlight"><pre><span></span><span class="c1">// random value generator function</span>

 <span class="kd">function</span> <span class="nx">hashIt</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sha</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">)</span>
  <span class="nx">sha</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">data</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">sha</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// salt generator function</span>

<span class="kd">function</span> <span class="nx">createSalt</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// this can go in environment variable</span>
  <span class="kd">var</span> <span class="nx">chars</span><span class="o">=</span><span class="s1">&#39;liDvM/OpICyK3MQzSzt/60px+mEMGco4Z1VhCxWVpxsHDF+zQB1wrhW/LvKdM49Dw5cz6PNoQRF0hmQFfhz3Cg==&#39;</span>
  <span class="kd">var</span> <span class="nx">salt</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">11</span><span class="p">;</span> <span class="nx">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span><span class="p">){</span>
    <span class="nx">salt</span> <span class="o">+=</span> <span class="nx">chars</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="nx">chars</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">))]</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">salt</span>
<span class="p">}</span>

<span class="nx">salt</span><span class="o">=</span><span class="nx">createSalt</span><span class="p">()</span> <span class="c1">// generate salt</span>
<span class="nx">password</span><span class="o">=</span><span class="nx">hashIt</span><span class="p">(</span><span class="nx">salt</span><span class="o">+</span><span class="nx">password</span><span class="p">)</span> <span class="c1">// mixture of plain text password and given salt</span>
<span class="nx">email</span><span class="o">=</span><span class="nx">email</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
<span class="nx">accountID</span><span class="o">=</span><span class="nx">hashIt</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="c1">// also hash email for user_id</span>

<span class="c1">// finally save the user object to the DB</span>
<span class="kd">var</span> <span class="nx">u</span> <span class="o">=</span> <span class="nx">UserModel</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
<span class="nx">u</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span> <span class="c1">// something like that</span>
</pre></div>


<h2 id="2-login">2. Login</h2>
<hr>
<div class="highlight"><pre><span></span><span class="nx">UserModel</span><span class="p">.</span><span class="nx">isActive</span><span class="p">()</span> <span class="c1">// before login make user to check whether user is activated.</span>
                     <span class="c1">// If not, promote the web console for activation link</span>

<span class="c1">// fetch saved salt &amp; compute hash for current password</span>
<span class="kd">var</span> <span class="nx">current_hash</span><span class="o">=</span><span class="nx">crypt</span><span class="p">.</span><span class="nx">hashIt</span><span class="p">((</span><span class="nx">saved_user_object</span><span class="p">.</span><span class="nx">salt</span><span class="p">)</span> <span class="o">+</span> <span class="nx">password</span><span class="p">)</span> 

<span class="kd">var</span> <span class="nx">saved_hash</span> <span class="o">=</span> <span class="nx">saved_user_object</span><span class="p">.</span><span class="nx">password</span> <span class="c1">// fetch hashed password from DB</span>

<span class="k">return</span> <span class="nb">Boolean</span><span class="p">(</span><span class="nx">current_hash</span> <span class="o">+</span> <span class="nx">saved_hash</span><span class="p">)</span> <span class="c1">// evalues to true/false</span>
</pre></div>


<h2 id="3-forgot-password">3. Forgot Password</h2>
<hr>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<span class="nx">token</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">secret</span> <span class="o">=</span> <span class="s1">&#39;&lt;secret string&gt;&#39;</span>
<span class="nx">token</span><span class="p">.</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">timeStep</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> 

<span class="kd">function</span> <span class="nx">generate</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">token</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="kd">var</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="nx">user_object</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="c1">// make one of your own</span>
<span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">generate</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">accountInfo</span><span class="o">=</span><span class="p">{</span>
  <span class="s1">&#39;email&#39;</span><span class="o">:</span><span class="nx">email</span><span class="p">,</span>
  <span class="s1">&#39;first_name&#39;</span><span class="o">:</span><span class="nx">result</span><span class="p">.</span><span class="nx">first_name</span><span class="p">,</span>
  <span class="s1">&#39;last_name&#39;</span><span class="o">:</span><span class="nx">result</span><span class="p">.</span><span class="nx">last_name</span><span class="p">,</span>
  <span class="s1">&#39;vhash&#39;</span><span class="o">:</span><span class="nx">auth</span><span class="p">,</span>
  <span class="s1">&#39;flag&#39;</span><span class="o">:</span><span class="nx">flag</span><span class="p">,</span>
  <span class="s1">&#39;time&#39;</span><span class="o">:</span><span class="nx">time</span><span class="p">,</span>
  <span class="c1">//other app specific params</span>
<span class="p">}</span>

<span class="nx">mail_user</span><span class="p">(</span><span class="nx">accountInfo</span><span class="p">)</span> <span class="c1">// mail user the link with vhash parameter</span>
</pre></div>


<h2 id="4-reset-password">4. Reset Password</h2>
<hr>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="nx">user_obj</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="nx">time</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
<span class="kd">var</span> <span class="nx">tokenTest</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span> <span class="c1">// get the auth &amp; time param from request body</span>
                                                                  <span class="c1">// to compose pattern</span>
<span class="kd">var</span> <span class="nx">tokenResponse</span> <span class="o">=</span> <span class="nx">tokenFeedback</span><span class="p">(</span><span class="nx">tokenTest</span><span class="p">)</span> <span class="c1">// only check valid token else say token is expired/wrong/invalid</span>

<span class="c1">//check for valid auth value </span>
<span class="nb">Boolean</span><span class="p">(</span><span class="nx">request</span><span class="p">[</span><span class="nx">body</span><span class="p">].</span><span class="nx">auth</span> <span class="o">===</span> <span class="nx">user_obj</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span> <span class="c1">//should be true</span>

<span class="c1">//reset password as follows</span>
<span class="kd">var</span> <span class="nx">salt</span><span class="o">=</span><span class="nx">createSalt</span><span class="p">()</span>
<span class="kd">var</span> <span class="nx">hashpass</span><span class="o">=</span><span class="nx">crypt</span><span class="p">.</span><span class="nx">hashIt</span><span class="p">(</span><span class="nx">salt</span> <span class="o">+</span> <span class="nx">password</span><span class="p">)</span>
</pre></div>
          </div>
          <div>
            <p>
              Tags -
                    <a href="https://rihbyne.github.io/tag/security">security</a>
                    <a href="https://rihbyne.github.io/tag/encryption">encryption</a>
                    <a href="https://rihbyne.github.io/tag/hashing">hashing</a>
                    <a href="https://rihbyne.github.io/tag/salting">salting</a>
            </p>
          </div>
        </article>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'swlogs';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            dsq.setAttribute('data-timestamp', +new Date());
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
    </div>


<footer class="blog-footer">

    <ul class="nav">
                    <li><a href="https://rihbyne.github.io/blog">posts</a></li>
                    <li class="dots">.</li>
                    <li><a href="https://rihbyne.github.io/diy">solos</a></li>
                    <li class="dots">.</li>
                    <li><a href="https://rihbyne.github.io/downloadables/resume.pdf">resume</a></li>
                    <li class="dots">.</li>
                    <li><a href="https://rihbyne.github.io/https://goodreads.com/rihanpereira">reading</a></li>
                    <li class="dots">.</li>
    </ul>

    <p class="disclaimer">
        Rihan &copy; 2019. Contents are <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/us/">cc by-nc-sa</a>. All opinions are of my own.
    </p>
</footer>
            </div>
    </body>
</html>